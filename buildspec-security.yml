# buildspec-security.yml
version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      # Update pip first
      - python -m pip install --upgrade pip
      # Install security tools
      - pip install safety bandit detect-secrets
      
  build:
    commands:
      # Create results directory
      - mkdir -p security-results
      
      # Static code analysis
      - echo "Running Bandit analysis..."
      - bandit -r src/ -f json -o security-results/bandit-report.json || true
      
      # Check for credentials/secrets
      - echo "Scanning for secrets..."
      - detect-secrets scan src/ > security-results/secrets-report.json
      
      # Check dependencies if requirements.txt exists
      - |
        if [ -f "requirements.txt" ]; then
          echo "Checking dependencies..."
          safety check -r requirements.txt --json > security-results/safety-report.json || true
        else
          echo "No requirements.txt found, skipping dependency check"
        fi
      
      # Evaluate results
      - |
        echo "=== Security Scan Summary ==="
        if [ -f "security-results/bandit-report.json" ]; then
          echo "Bandit scan completed"
        fi
        if [ -f "security-results/secrets-report.json" ]; then
          echo "Secrets scan completed"
        fi
        if [ -f "security-results/safety-report.json" ]; then
          echo "Dependencies scan completed"
        fi

artifacts:
  files:
    - security-results/**/*
  discard-paths: no

reports:
  security-reports:
    files:
      - security-results/*.json
    file-format: JSON
